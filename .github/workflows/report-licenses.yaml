name: 'Report Licenses'

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  license-report:
    runs-on: ubuntu-latest

    steps:
      - name: 'Checkout source code'
        uses: actions/checkout@v4

      - name: 'Delete package-lock.json'
        run: rm -f package-lock.json

      - name: 'Setup Node.js environment'
        uses: actions/setup-node@v4
        with:
          node-version-file: '.tool-versions'

      - name: 'Install dependencies'
        run: npm install

      - name: 'Generate license report'
        id: generate-report
        run: npm run licenses:html

      - name: 'Upload license report artifact'
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: license-report.html

      - name: 'Clean up report html'
        id: clean-html
        run: |
          HTML_CONTENT=$(cat license-report.html)
          LICENSE_REPORT=$(echo "$HTML_CONTENT" | sed -E 's/<style[^>]*>.*?<\\/style>//g')
          echo "LICENSE_REPORT<<EOF" >> $GITHUB_ENV
          echo "$LICENSE_REPORT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: 'Report licenses on pull request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: license
          message: |
            A license report has been generated:

            <details>
              <summary>License Report</summary>
              ${{ env.LICENSE_REPORT }}
            </details>

            You can also download the report as an artifact:
            [License Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
